import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Helm Chart

The Helm chart deploys a CloudQuery fetch CronJob on kubernetes and everything required to execute it.
You can either configure CloudQuery to 'fetch' into your own PostgreSQL database (e.g self-hosted, RDS, CloudSQL, etc..), or use the helm chart
to set up a PostgreSQL instance in you kubernetes cluster.

:::info
You should use a PostgreSQL version >11.
:::

The chart source can be found here [github.com/cloudquery/helm-charts](https://github.com/cloudquery/helm-charts).

## Prerequisites

* [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl) installed.
* [Helm v3](https://helm.sh) installed.

## Clone the Helm Chart Repository

Clone the [cloudquery/helm-charts](https://github.com/cloudquery/helm-charts) (all commands in this tutorial will asume
it's downloaded and you are at the root directory).

```bash
git clone https://github.com/cloudquery/helm-charts.git
cd helm-charts
```

## [If you don't have one] Set up an EKS or GKE cluster

If you don't have a kubernetes cluster already, we provide a few terraform examples that can help you spawn one.
You can use the following terraforms as is, fine-tune them and/or incorporate them into your existing 
infrastructure-as-code. 

- First, [make sure that terraform is installed](https://learn.hashicorp.com/tutorials/terraform/install-cli).
- Terraform needs to be authenticated with your cloud provider (e.g. by exporting environment variables before
  running `terraform apply`).
  - [AWS instructions](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#authentication).
  - [GCP instructions](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#authentication)

:::caution
These are just examples. Make sure to review them thoroughly before calling `terraform apply` on your cloud.
:::

<Tabs
  defaultValue="eks"
  values={[
    {label: 'EKS', value: 'eks'},
    {label: 'GKE', value: 'gke'},
  ]}>
<TabItem value="eks">

Run the following commands to provision an EKS cluster with managed nodes (**CloudQuery currently is not supported on Fargate nodes**).
**Please note:** EKS can take 15-25 min to provision, see [aws github issue](https://github.com/aws/containers-roadmap/issues/1227).

```bash
cd terraform/aws
terraform init
cp terraform.tfvars.example terraform.tfvars
# specify required variables in terraform.tfvars
terraform apply
```

Once the EKS is provisioned run the following commands to authenticate the `kubectl` with the above cluster.

```bash
  aws eks update-kubeconfig --region <YOUR_REGION> --name cloudquery-eks
```

:::caution Troubleshooting

There is an [open issue](https://github.com/aws/aws-cli/issues/4843) in `aws` CLI that can cause `update-kubeconfig` to fail.
You can work around this issue by deleting `~/.kube` and re-running the command.

:::

</TabItem>

<TabItem value="gke">

Run the following commands to provision a GKE Cluster.

```bash
cd terraform/gcp
terraform init
cp terraform.tfvars.example terraform.tfvars
# specify required variables in terraform.tfvars
terraform apply
```
Once the GKE is provisioned run the following command to authenticate the `kubectl` with the above cluster.

```bash
gcloud container clusters get-credentials cloudquery --zone <YOUR_ZONE>
```
</TabItem>
</Tabs>

## Installing CloudQuery Helm Chart

:::info

To install a helm chart, your kubectl needs to be configured to access your kubernetes cluster. If you followed
the steps above, you should be good to go! If not, you might need to call `aws eks update-kubeconfig` or `gcloud container clusters get-credentials`.

:::

First, download Helm dependencies:

```bash
helm dependencies update
```
 
CloudQuery can be configured to run with various dependencies.
The suggested way is to use your own external database (potentially a managed RDS or GCP CloudSQL) but you can 
also spawn a PostgreSQL database together with the helm chart.

#### Installing CloudQuery without PostgreSQL

Following are the minimum steps you need to do before running `helm install`:

* Edit the `config.hcl` file to define what and how you want cloudquery to fetch the information.

In `values.yaml`:
* Update `envRenderSecret:CQ_VAR_DSN` to point to your external database.
* Add any additional envirmoent variables under `envRenderSecret` needed for CloudQuery to authenticate with your cloud provider.
* Update `schedule` with the required schedule you want CloudQuery to run (https://crontab.guru/).

To install just run:

```bash
helm install cloudquery .
```

You will see the following output

```text
cloudquery . 
NAME: cloudquery
LAST DEPLOYED: Thu Feb 10 13:59:29 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
1. Welcome! CloudQuery is Installed.
2. To trigger the cronjob manually run:
   kubectl create job --from=cronjob/cloudquery-cron cloudquery-cron
3. To see logs for the job run:
   kubectl logs -f jobs/cloudquery-cron
4. To exec to the admin container with cloudquery binary for debugging purposes run:
   kubectl exec -it deployment/cloudquery-admin -- /bin/sh
```

#### Installing CloudQuery with PostgreSQL

In addition to the steps defined in the previous section you need to do the following before running `helm install cloudquery .`

In `values.yaml`
* Update `postgresql.enabled` to `true`
* Under `postgresql`, update `postgresqlUsername`,  `postgresqlPassword` and `postgresqlDatabase` to your wanted values.

### Uninstalling helm chart

To uninstall, run:

```bash
helm uninstall cloudquery
```
